<!doctype html>
<html lang="ja">

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1">

	<title>DEMO Html5-QRCode</title>

	<link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null"
		href="https://fonts.googleapis.com/css?family=Roboto:300,300italic,700,700italic">
	<link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null"
		href="https://unpkg.com/normalize.css@8.0.0/normalize.css">
	<link rel="stylesheet" rel="preload" as="style" onload="this.rel='stylesheet';this.onload=null"
		href="https://unpkg.com/milligram@1.3.0/dist/milligram.min.css">
	<script type="text/javascript" src="html5-qrcode.min.js"></script>
</head>

<body>
	https://unpkg.com/html5-qrcode@latest/html5-qrcode.min.js

	<main class="wrapper" style="padding-top:2em">
		<section class="container" id="demo-content">
			<h3 class="title">バーコードリーダー</h3>
			<div id="sourceSelectPanel" style="display: none;">
				<label for="sourceSelect">カメラ:</label>
				<select id="sourceSelect" style="max-width:400px">
				</select>
			</div>
			<div>
				<a class="button" id="startButton">読み取り開始</a>
				<a class="button" id="stopButton">読み取り停止</a>
			</div>
			<div id="reader" style="width:400px; height: 400px; border: 1px solid gray; text-align: center;">
			</div>
			<hr>
			<label>Result:</label>
			<pre><code id="result"></code></pre>
			<a class="button" id="resetButton">clear</a>

		</section>
	</main>

	<script type="text/javascript">
		function onScanSuccess(decodedText, decodedResult) {
			// handle the scanned code as you like, for example:
			console.log(`Code matched = ${decodedText}`, decodedResult);
		}

		function onScanFailure(error) {
			// handle scan failure, usually better to ignore and keep scanning.
			// for example:
			console.warn(`Code scan error = ${error}`);
		}

		// const html5QrcodeScanner = new Html5QrcodeScanner('reader', {fps:10,qrbox:250})
		// html5QrcodeScanner.render(onScanSuccess, onScanFailure)

		Html5Qrcode.getCameras().then(cameras => {
			console.log(cameras)
			const sourceSelect = document.getElementById('sourceSelect')
			let selectedDeviceId = cameras[0].id
			console.log(selectedDeviceId)

			if (cameras.length >= 1) {
				cameras.forEach((element) => {
					const sourceOption = document.createElement('option')
					sourceOption.text = element.label
					sourceOption.value = element.deviceId
					sourceSelect.appendChild(sourceOption)
				})

				sourceSelect.onchange = () => {
					selectedDeviceId = sourceSelect.value;
				};

				const sourceSelectPanel = document.getElementById('sourceSelectPanel')
				sourceSelectPanel.style.display = 'block'
			}

			const html5QrCode = new Html5Qrcode("reader")
			let current_text = ''

			document.getElementById('resetButton').addEventListener('click', clearResult)
			document.getElementById('startButton').addEventListener('click', startScanner)
			document.getElementById('stopButton').addEventListener('click', stopScanner)

			function startScanner() {
				console.log(selectedDeviceId)
				html5QrCode.start(
					selectedDeviceId,
					{
						aspectRatio: 1.0,
						fps: 10,
						qrbox: { width: 300, height: 300 },
						supportedScanTypes : Html5QrcodeScanType.SCAN_TYPE_CAMERA,
						formatsToSupport: [Html5QrcodeSupportedFormats.QR_CODE,Html5QrcodeSupportedFormats.EAN_13]
					},
					(decodedText, decodedResult) => {
						if (current_text !== decodedText) {
							current_text = decodedText
							// document.getElementById('result').textContent = decodedText + "\n" + document.getElementById('result').textContent
							document.getElementById('result').prepend(decodedText + "\n")
						}
					},
					(errorMessage) => { }
				).catch(err => {
					console.log(err)
				})
				// if (scanning) return;
				// scaning = true
				// scanned = false
				// codeReader.decodeFromVideoDevice(selectedDeviceId, 'video', (result, err) => {
				// 	if (result && !scanned) {
				// 		scanned = true
				// 		console.log(result)
				// 		// document.getElementById('result').textContent = result.text
				// 		document.getElementById('result').textContent = result.text + "\n" + document.getElementById('result').textContent

				// 		setTimeout(() => {
				// 			scanned = false
				// 		}, 1000)
				// 	}
				// 	if (err && !(err instanceof ZXing.NotFoundException)) {
				// 		document.getElementById('result').textContent = err + "\n" + document.getElementById('result').textContent
				// 	}
				// }).catch(err => stopScanner())
			}

			function stopScanner() {
				current_text = ''
				html5QrCode.stop()
			}

			function clearResult() {
				document.getElementById('result').textContent = ''
			}
		}).catch(err => {
			console.log(err)
		})

		// This method will trigger user permissions
		// Html5Qrcode.getCameras().then(devices => {
		// 	/**
		// 	 * devices would be an array of objects of type:
		// 	 * { id: "id", label: "label" }
		// 	 */
		// 	if (devices && devices.length) {
		// 		var cameraId = devices[0].id;
		// 		// .. use this to start scanning.
		// 		html5Qrcode.start(
		// 			cameraId,
		// 			{
		// 				fps: 10,
		// 				qrbox: { width: 250, height: 250 }
		// 			},
		// 			(decodedText, decodedResult) => {
		// 				console.log(`Code matched = ${decodedText}`, decodedResult);
		// 			},
		// 			(errorMessage) => {
		// 				console.log(`Errror = ${errorMessage}`);
		// 			}).catch((err) => {
		// 				console.error(err)
		// 			})
		// 	}
		// }).catch(err => {
		// 	// handle err
		// });
	</script>

</body>

</html>